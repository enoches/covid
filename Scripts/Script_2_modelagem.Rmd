---
title: "Visualizacao Averting Expenditures Covid"
author: "Claudiano Neto"
# date: '`r format(Sys.Date())`'
geometry: margin = 1cm
output:
  html_document:
    theme: flatly
    highlight: tango
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning=FALSE}
library(scales)
library(tidyverse)
library(magrittr)
library(utf8)
```

```{r}
library(haven)

covid_basedados_imputado <- read_dta("C:/Users/User/Dropbox/Averting Expenditures Paper/rmd/dados_dta/covid_basedados_imputado.dta")

# Deixando a base sem NA's
base_cov <- na.omit(covid_basedados_imputado)
```

reg_gd
reg_ed_prob_6




# Testando modelos 
```{r}
library(stargazer)


ols_gd <- lm(gasto_equip_defensivo ~  + sexo + estcivil + morte_cov + contat_cov + filho_dep + idade + deaths + confirmed + d_raca + renda + d_escolaridade, data = base_cov)

summary(ols_gd)

# Depois de analisar os dados acima, optei por escolher o modelo "reg_ed_prob"

```


# Calculando os Efeitos marginais do PROBIT

```{r}
# https://github.com/leeper/margins

library("margins")
library("datasets")
library("stargazer")

probit_1 <- glm(equip_defensiv ~ sexo + estcivil + morte_cov + contat_cov + filho_dep + idade + deaths + confirmed + d_raca + renda + d_escolaridade, data = base_cov, family = binomial(link = "probit"))

probit_2 <- glm(equip_defensiv ~ sexo + estcivil + morte_cov + contat_cov + filho_dep + idade + deaths + confirmed + renda + d_escolaridade, data = base_cov, family = binomial(link = "probit"))

probit_3 <- glm(equip_defensiv ~ sexo + estcivil + morte_cov + contat_cov + filho_dep + idade + deaths + confirmed + d_escolaridade, data = base_cov, family = binomial(link = "probit"))

probit_4 <- glm(equip_defensiv ~ sexo + estcivil + morte_cov + contat_cov + filho_dep + deaths + confirmed + d_escolaridade, data = base_cov, family = binomial(link = "probit"))

probit_5 <- glm(equip_defensiv ~ sexo + estcivil + morte_cov + contat_cov + idade + deaths + confirmed + d_escolaridade, data = base_cov, family = binomial(link = "probit"))

# Esse modelo ficou bastante interessante. Melhor discutir com cadu e Roberta
probit_6 <- glm(equip_defensiv ~ sexo + estcivil + morte_cov + contat_cov + deaths + confirmed + d_escolaridade, data = base_cov, family = binomial(link = "probit"))

stargazer(probit_1, probit_2, probit_3, probit_4, probit_5, probit_6, type = 'text')

# considerando os modelos GLM, escolho o modelo probit_6

```

```{r}
# valores marginais 

# https://github.com/leeper/margins

library("margins")

#Modelo OlS
summary(ols_gd)
plot(margins(ols_gd))
summary(margins(ols_gd))

#Modelo PROBIT
summary(probit_6)
plot(margins(probit_6))
summary(margins(probit_6))
```

```{r}
# Calculando intervalo de confianca

confint((ols_gd))
confint(probit_6)
```

```{r}
# Wald Test

library(aod)
wald.test(b = coef(ols_gd), Sigma = vcov(ols_gd), Terms = 6:10)
wald.test(b = coef(probit_6), Sigma = vcov(probit_6), Terms = 4:6)

```


```{r}
# McFadden's Pseudo R-squared
probit_60 <- update(probit_6, formula= equip_defensiv ~ 1)   # Calcula o LL mantendo Y constante.
McFadden<- 1-as.vector(logLik(probit_6)/logLik(probit_60))
McFadden


# acredito que o teste McFadden nao seja aplicavél para ols de variavel dependente continua
ols_gd0 <- update(ols_gd, formula= gasto_equip_defensivo ~ 1)   # Calcula o LL mantendo Y constante.
McFadden_ols <- 1-as.vector(logLik(ols_gd)/logLik(ols_gd0))
McFadden_ols
# resultado de 0.12 estÃ¡ fora do intervalo sugerido por Louviere, e abaixo do obtido com a base_imp.

# o valor de 0.22 estÃ¡ dentro do range de 0.20 - 0.40 sugerido por Louviere et al (2000). "Stated Choice Methods: Analysis and Applications". Cambridge University Press., pagina 55.

# A explicacao para essa parte vem: https://portal.uni-freiburg.de/empiwifo/teaching/summer-term-09/materials-microeconometrics/probit_7-5-09.pdf 
```

A respeito do McFadden: Ele compara a probabilidade de log irrestrita Lur para o modelo que estamos estimando e a probabilidade de log restrita Lr com apenas uma interceptaÃ§Ã£o. Se as variÃ¡veis independentes nÃ£o tiverem poder explicativo, o modelo restrito serÃ¡ o mesmo que o modelo irrestrito e R ao quadrado serÃ¡ 0.
Para ver mais detalhes sobre teste de hipoteses, ver: https://www.empiwifo.uni-freiburg.de/teaching/summer-term-09/materials-microeconometrics/probit_7-5-09.pdf .
Para encontrar a diferenÃ§a de desvio para os dois modelos (ou seja, a estatÃ?stica do teste), podemos calcular a alteraÃ§Ã£o no desvio e testÃ¡-la usando um teste do qui quadrado - a mudanÃ§a no desvio distribuÃ?da como qui quadrado na mudanÃ§a nos graus de liberdade.
Diggle, P.J., Liang, K.-Y., Zeger, S.L., 1994. Analysis of longitudinal data. Oxford, Clarendon Press, 253 p. Draper, N.R., Smith, H., 1998. Applied Regression Analysis. New York, John Wiley & Sons, Inc., 706 p.

```{r}
library(rsq)

# likelihood-ratio-based R^2
rsq(probit_6, adj = TRUE, type = 'lr')

#Calculate the likelihood-ratio-based R^2 for generalized linear models.
rsq.lr(ols_gd, adj = TRUE)
```

```{r}

## change in deviance
with(ols_gd, null.deviance - deviance)
## change in degrees of freedom
with(ols_gd, df.null - df.residual)
## chi square test p-value
with(ols_gd, pchisq(null.deviance - deviance, df.null - df.residual, lower.tail = FALSE))
# Razao de verossimilhanca
logLik(ols_gd)


## change in deviance
with(probit_6, null.deviance - deviance)
## change in degrees of freedom
with(probit_6, df.null - df.residual)
## chi square test p-value
with(probit_6, pchisq(null.deviance - deviance, df.null - df.residual, lower.tail = FALSE))
# Razao de verossimilhanca
logLik(probit_6)
```

O qui-quadrado de 234.8032 com 11 graus de liberdade e um valor p associado < 0,001 nos diz que nosso modelo como um todo se encaixa significativamente melhor que um modelo vazio. As vezes, isso Ã© chamado de teste da razÃ£o de verossimilhanÃ§a (o desvio residual Ã© -2 * log verossimilhanÃ§a). A probabilidade de log do modelo foi -791.4241.


```{r}
# Multiple linear regression
# 
# summary(reg_ed_prob)
# confint(reg_ed_prob, level=0.95)   # intervalo de confianca
# anova(reg_ed_prob)    # teste anova
# ```
# 
# 
# ```{r}
# # Plotting regression line
# plot(log(gasto_equip_defensivo) ~ d_escolaridade + sexo + estcivil + morte_cov + contat_cov + filho_dep + idade + d_raca + renda, data = base_cov)
```

```{r}
# Plotando valores marginais

#https://cran.r-project.org/web/packages/sjPlot/vignettes/plot_marginal_effects.html

# library(sjPlot)
# library(ggeffects)
# library(ggplot2)
# theme_set(theme_sjplot())
# 
# plot_model(reg_ed_prob, type = "pred", terms = "idade")
# plot_model(reg_ed_prob, type = "pred", terms = "renda")
# plot_model(reg_ed_prob, type = "pred", terms = "filho_dep")
```



```{r, message=FALSE, warning=FALSE}
# confint(teste7)
```


```{r, message=FALSE, warning=FALSE}
#   https://stats.idre.ucla.edu/r/dae/probit-regression/
#   https://stats.idre.ucla.edu/stat/data/intro_r/intro_r_interactive.html#(61)
# require(aod)
# wald.test(b = coef(teste7), Sigma = vcov(teste7), Terms = 4:6)
```


```{r, message=FALSE, warning=FALSE}
#depois de montar a equaÃ§Ã£o final 
#acessar https://jbhender.github.io/Stats506/F18/GP/Group14.html 
# para ver como fazer graficos interessantes

# https://stats.idre.ucla.edu/r/dae/ordinal-logistic-regression/

```

# Pesquisar novamente o site https://www.statmethods.net/stats/regression.html

Procurar HECKMAN



/